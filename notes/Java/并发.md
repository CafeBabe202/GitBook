# ğŸ˜€ å¹¶å‘

æœ€è¿‘çœ‹äº†Javaæ ¸å¿ƒæŠ€æœ¯å·ä¸€ï¼Œçœ‹å®Œäº†è¿½åä¸€ç« çš„å¹¶å‘ï¼Œæ„Ÿè§‰å­¦ä¹ åˆ°äº†å¾ˆå¤šæ–°çš„ä¸œè¥¿ï¼Œä¹Ÿå†™äº†ä¸€äº›æ ·ä¾‹ä»£ç ï¼Œæ‰“ç®—æ˜å¤©çœ‹å·äºŒï¼Œä»Šå¤©æ¥åšä¸ªç®€å•çš„æ€»ç»“ï¼Œåˆšå¼€å§‹å†™åšå®¢ï¼Œå†™çš„å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå¯èƒ½æœ‰ç‚¹ç²—ç³™ï¼Œè¯·è§è°…ã€‚

## ä¸€ã€çº¿ç¨‹

### 1.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹

> çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—çš„æœ€å°è°ƒåº¦å•ä½ï¼Œå®ƒåŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ï¼Œå¯ä»¥é€šè¿‡ä»–è¿›è¡Œå¤šå¤„ç†å™¨ç¼–ç¨‹ï¼Œä½¿ç”¨å¤šçº¿ç¨‹å¯¹è¿ç®—å¯†é›†å‹ä»»åŠ¡è¿›è¡ŒåŠ é€Ÿã€‚

### 1.2 åˆ›å»ºä¸€ä¸ªçº¿ç¨‹

åˆ›å»ºçº¿ç¨‹æœ‰å¤šç§æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿Threadç±»å¹¶é‡å†™runæ–¹æ³•ï¼›å¯ä»¥å®ç°Runnableæ¥å£å¹¶ä¼ å…¥Threadä¸­ï¼Œå¯ä»¥äº‹é¡¹Callableä¸­æ¥åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è¿”å›å€¼çš„çº¿ç¨‹ï¼›ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± æ¥æ‰§è¡Œä½ çš„ä»»åŠ¡ã€‚

é¦–å…ˆå°†ç¤ºèŒƒæ˜¯ä½¿ç”¨ç»§æ‰¿Threadç±»å’Œå®ç°Runnableæ¥å£çš„æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚

#### ç»§æ‰¿Thread

```java
public class TestThread{
    public static void main(String[] args){
        MyThread thread = new MyThread();
        /**
         * é€šè¿‡startæ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹
         * ä»–ä¼šè‡ªåŠ¨è°ƒç”¨runæ–¹æ³•
         * å¦‚æœæ‰‹åŠ¨è°ƒç”¨æ¶¦æ–¹æ³•å°†ä¸èƒ½åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯ç®€å•çš„è¿è¡Œrunæ–¹æ³•
         */
        thread.start();
    }
}
//é€šè¿‡ç»§æ‰¿Threadç±»æ¥åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„çº¿ç¨‹ç±»
class MyThread extends Thread{
    /**
     * runæ–¹æ³•æ˜¯çº¿ç¨‹çš„å¯åŠ¨å…¥å£æ–¹æ³•ï¼Œç›¸å½“äºmainæ–¹æ³•
     * åªèƒ½é‡å†™runæ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•ä¸èƒ½æˆä¸ºçº¿ç¨‹å…¥å£
     */
    @Override
    public void run(){
        System.out.println("Hello Thread!");
    }
}
```

#### å®ç°Runnable

```java
public class TestRunnable {
    public static void main(String[] args){
        //åˆ›å»ºä¸€ä¸ªRunnableç±»
        Runnable runnable = new MyThread();
        //é€šè¿‡Runnableåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        Thread thread = new Thread(runnable);
        //å¯åŠ¨çº¿ç¨‹å¯¹è±¡
        thread.start();
    }
}
//åŒå¤Ÿå®ç°runnalbeæ¥å£æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç±»
class MyThread implements Runnable{
    //ä¾ç„¶æ˜¯é‡å†™runæ–¹æ³•
    @Override
    public void run(){
        System.out.println("Hello Runnable");
    }
}
```

åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ååˆ†ç®€å•ï¼Œä½¿ç”¨Runnableåˆ›å»ºçº¿ç¨‹ä½ ç”šè‡³å¯ä»¥é€šè¿‡lambdaè¡¨è¾¾å¼æ¥ä½¿ç”¨ä¸€è¡Œä»£ç åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼š`new Thread(()->Sytem.out.println("Hello Runnable"));`

### 1.3 çº¿ç¨‹çš„çŠ¶æ€

ä¸€ä¸ªJavaçº¿ç¨‹åŒ…å«6ç§çŠ¶æ€ï¼š

Newï¼ˆæ–°å»ºï¼‰ã€Runnableï¼ˆå¯è¿è¡Œï¼‰ã€Blockedï¼ˆé˜»å¡ï¼‰ã€Waitingï¼ˆç­‰å¾…ï¼‰ã€Time waitingï¼ˆè®¡æ—¶ç­‰å¾…ï¼‰ï¼ŒTerminatedï¼ˆç»ˆæ­¢ï¼‰

#### New

åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Threadå¯¹è±¡ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨startæ–¹æ³•æ¥å¯åŠ¨è¿™ä¸ªçº¿ç¨‹ã€‚

#### Runnable

ä¸€æ—¦è°ƒç”¨äº†startæ–¹æ³•ï¼Œçº¿ç¨‹å°±è¿›å…¥RunnableçŠ¶æ€ï¼Œä¸€ä¸ªå¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹å¯èƒ½æ­£è¿è¡Œä¹Ÿå¯èƒ½æ²¡æœ‰è¿è¡Œï¼ŒJavaå¹¶æ²¡æœ‰å°†æ­£åœ¨è¿è¡Œçš„çŠ¶æ€ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„çŠ¶æ€ã€‚ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ä¾æ—§å¤„äºå¯è¿è¡ŒçŠ¶æ€ã€‚

#### Blocked

å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå†…éƒ¨çš„å¯¹è±¡é”ï¼ˆè€Œä¸æ˜¯java.util.concurrentåº“ä¸­çš„Lockï¼‰ï¼Œè€Œè¿™ä¸ªé”ç›®å‰è¢«å…¶ä»–çº¿ç¨‹å æœ‰ï¼Œè¯¥çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ã€‚

#### Waiting

å½“ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹é€šçŸ¥è°ƒåº¦å‡ºç°ä¸€ä¸ªæ¡ä»¶æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

#### Time waiting

æœ‰å‡ ä¸ªå½“æ³•æœ‰è¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨è¿™äº›æ–¹æ³•ä¼šè®©çº¿ç¨‹è¿›å…¥è®¡æ—¶ç­‰å¾…çŠ¶æ€ã€‚è¿™ä¸€çŠ¶æ€çŸ¥é“è®¡æ—¶æœŸæ»¡æˆ–è€…æ¥æ”¶åˆ°é€‚å½“çš„é€šçŸ¥ã€‚å¸¦æœ‰è¶…æ—¶å‚æ•°çš„æ–¹æ³•æœ‰Thread.sleepå’Œè®¡æ—¶ç‰ˆçš„Object.waitã€Thread.joinã€Lock.tryLockä»¥åŠCondition.awaitã€‚

#### Terminated

çº¿ç¨‹ä¼šç”±äºä¸€ä¸‹ä¸¤ä¸ªåŸå› ä¹‹ä¸€è€Œç»ˆæ­¢ï¼šrunæ–¹æ³•æ­£å¸¸é€€å‡ºï¼Œçº¿ç¨‹è‡ªç„¶ç»ˆæ­¢ï¼›å› ä¸ºä¸€ä¸ªæ²¡æœ‰æ•è·çš„å¼‚ç»ˆæ­¢äº†runæ–¹æ³•ï¼Œæ˜¯çº¿ç¨‹æ„å¤–ç»ˆæ­¢ã€‚

### 1.4 çº¿ç¨‹ä¸­æ–­

é™¤äº†ä¸€ä¸ªåºŸå¼ƒçš„stopæ–¹æ³•ï¼Œæ²¡æœ‰åŠæ³•å¯ä»¥å¼ºåˆ¶çº¿ç¨‹ç»ˆæ­¢ï¼Œä¸è¿‡ï¼Œinterruptæ–¹æ³•å¯ä»¥ç”¨æ¥è¯·æ±‚ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½åº”è¯¥æ˜¯ä¸æ˜¯çš„æ£€æŸ¥è¿™ä¸ªæ ‡å¿—ï¼Œä»¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚

#### ç¤ºä¾‹

```java
public class TestInterrupted {
    public static void main(String[] args) throws InterruptedException{
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹
        Thread myThread = new Thread(new MyThread());
        //å¯åŠ¨å¹¶æ¨¡æ‹Ÿæ¯éš”ä¸€æ®µæ—¶é—´è¯·æ±‚ä¸­æ–­ä¸€æ¬¡
        myThread.start();
        Thread.sleep(3000);
        for(int i=0;i<2;i++){
            myThread.interrupt();
            Thread.sleep(4000);
        }
    }
}
//åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç±»
class MyThread implements Runnable {
    public void run() {
        int count = 0;
        while (true) {
            //æ¨¡æ‹Ÿç¨‹åºæ­£å¸¸è¿è¡Œ
            System.out.println("Running...");
            try {
                //å½“ä¼‘çœ çš„çº¿ç¨‹è¢«è¯·æ±‚ä¸­æ–­æ—¶ï¼ŒæŠ›å‡ºInterrruptedExceptionï¼Œå¹¶æ¸…é™¤ä¸­æ–­è¯·æ±‚æ ‡å¿—
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                //å½“æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼Œè¡¨æ˜çº¿ç¨‹è¢«è¯·æ±‚ä¸­æ–­ã€‚
                //è®¡æ•°+1,å½“è¯·æ±‚ä¸¤æ¬¡ä¸­æ–­æ—¶ï¼Œå°†æ¨å‡ºæ–¹æ³•
                count++;
                System.out.println("interruptered");
            }
            //å¦‚æœè¯·æ±‚çš„ä¸­æ–­çš„æ¬¡æ•°æ˜¯2ï¼Œå°†æ¨å‡ºçº¿ç¨‹
            if(count==2){
                System.out.println("ä¸­æ–­ä¸¤æ¬¡ï¼Œå°†é€€å‡º...");
                return;
            }
        }
    }
}
```

#### interruptedä¸IisInterruptedåŒºåˆ«

|               | æ˜¯å¦æ˜¯é™æ€æ–¹æ³• | æ˜¯å¦æ¸…é™¤ä¸­æ–­çŠ¶æ€ |
| :-----------: | :-----: | :------: |
|  interrupted  |    æ˜¯    |     æ˜¯    |
| isInterrupted |    å¦    |     å¦    |

### 1.5 åŒæ­¥

#### é—®é¢˜

åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯æ„è§å¾ˆç®€å•çš„äº‹æƒ…ï¼Œä½†æ˜¯å¦‚ä½•ä½¿çº¿ç¨‹ä¹‹é—´åè°ƒè¿è¡Œï¼Œä¸ä¼šå‘ç”Ÿç”±äºå¤šçº¿ç¨‹è€Œå¼•å‘çš„BUGæ˜¯ä¸€ä¸ªéš¾é¢˜ã€‚

é¦–å…ˆæ¥çœ‹ä¸€ä¸ªä¼šå¼•å‘é—®é¢˜çš„ä»£ç 

```java
import java.util.Arrays;

public class demo {
    public static final int NACCOUNTS = 100;
    public static final double INITIAL_BALANCE = 1000;
    public static final double MAX_AMOUNT = 1000;

    public static void main(String[] args) {
        UnsynchBank bank = new UnsynchBank(NACCOUNTS, INITIAL_BALANCE);
        for (int i = 0; i < NACCOUNTS; i++) {
            int fromAccount = i;
            Runnable r = () -> {
                try {
                    while (true) {
                        int toAccount = (int) (bank.size() * Math.random());
                        double amount = MAX_AMOUNT * Math.random();
                        bank.transfer(fromAccount, toAccount, amount);
                        Thread.sleep((int) Math.random());
                    }
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            };
            Thread t = new Thread(r);
            t.start();
        }

    }
}

// åˆ›å»ºä¸€ä¸ªéåŒæ­¥é“¶è¡Œç±»
class UnsynchBank {
    private final double[] accounts;

    public UnsynchBank(int n, double initialBalance) {
        this.accounts = new double[n];
        Arrays.fill(accounts, initialBalance);
    }

    public void transfer(int from, int to, double amount) {
        if (accounts[from] < amount)
            return;
        System.out.print(Thread.currentThread());
        /**
         * += ã€-= æ“ä½œä¸æ˜¯åŸå­æ“ä½œï¼Œè€Œæ˜¯åˆ†ä¸ºä¸‰ä¸ªåŸå­æ“ä½œ 1ã€å°† accounts[to] åŠ è½½åˆ°å¯„å­˜å™¨ 2ã€å¢åŠ  amount 3ã€å°†ç»“æœå†™å›
         * å¦‚æœå·²å°†å€¼åŠ è½½åˆ°å¯„å­˜å™¨ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¿˜æ²¡æœ‰å†™å›å†…å­˜ä¹‹å‰çº¿ç¨‹å¤±å»äº†æ‰§è¡Œæƒ
         * å½“å…¶ä»–çº¿ç¨‹å¯¹å†…å­˜ä¸­çš„å€¼è¿›è¡Œä¿®æ”¹æ—¶ï¼Œè¯¥çº¿ç¨‹å¹¶ä¸çŸ¥é“ï¼Œè€Œå½“è¯¥çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œæ—¶ ç›´æ¥å°†å€¼å†™å›å†…å­˜ï¼Œå°±ä¼šé€ æˆæ•°æ®çš„è¦†ç›–ï¼Œä»è€Œç ´åæ•°æ®ã€‚
         */
        accounts[from] -= amount;
        accounts[to] += amount;
        System.out.printf(" %10.2f from %d to %d Total Balance: %10.2f%n", amount, from, to, getToatlBalance());
    }

    public double getToatlBalance() {
        double sum = 0;
        for (double a : accounts)
            sum += a;
        return sum;
    }

    public int size() {
        return this.accounts.length;
    }

}
```

ç”±äºè½¬è´¦çš„æ“ä½œå¹¶æ²¡æœ‰è¿›è¡ŒåŒæ­¥å¤„ç†ï¼Œç¨‹åºè¿è¡Œä¸€æ®µæ—¶é—´åå°±ä¼šå‡ºç°é—®é¢˜ï¼Œä½ ä¼šå‘ç°æ‰€æœ‰è´¦æˆ·ä¸­çš„æ€»ä½™é¢å¹¶ä¸æ˜¯100000ï¼Œè€Œæ˜¯å‡ºç°äº†é—®é¢˜

```
Thread[Thread-79,5,main]     670.89 from 79 to 53 Total Balance:   99976.83
Thread[Thread-84,5,main]      28.30 from 84 to 54 Total Balance:   99976.83
```

è¿™æ˜¯ç”±äº_ç«æ€æ¡ä»¶_å¯¼è‡´çš„ï¼Œè¿™ç§å¶å°”å‘ç”Ÿçš„BUGéå¸¸ä»¤äººå¤´ç–¼ã€‚

> **ç«æ€æ¡ä»¶**ï¼šè®¡ç®—çš„æ­£ç¡®æ€§å–å†³äºå¤šä¸ªçº¿ç¨‹çš„äº¤æ›¿æ‰§è¡Œæ—¶åºæ—¶ï¼Œå°±ä¼šå‘ç”Ÿç«æ€æ¡ä»¶ã€‚
>
> **ä¸´ç•ŒåŒº**ï¼šå¯¼è‡´ç«æ€æ¡ä»¶å‘ç”Ÿçš„ä»£ç åŒºã€‚

#### é”å¯¹è±¡

é”å¯¹è±¡å¯ä»¥æ§åˆ¶å¹¶å‘åŒºçš„ä»£ç å—ï¼Œä½¿å¾—åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´è¿è¡Œä¸´ç•ŒåŒºä»£ç ï¼Œè¿™æ ·ä»¬å°±å¯ä»¥è§£å†³ç”±äºå¤šçº¿ç¨‹é€ æˆçš„æ•°æ®ç ´åé—®é¢˜ã€‚

```java
import java.util.Arrays;
import java.util.concurrent.locks.ReentrantLock;

public class TestBank {
    public static final int NACCOUNTS = 100;
    public static final double INITIAL_BALANCE = 1000;
    public static final double MAX_AMOUNT = 1000;

    public static void main(String[] args) {
        SynchBank bank = new SynchBank(NACCOUNTS, INITIAL_BALANCE);
        for (int i = 0; i < NACCOUNTS; i++) {
            int fromAccount = i;
            Runnable r = () -> {
                try {
                    while (true) {
                        int toAccount = (int) (bank.size() * Math.random());
                        double amount = MAX_AMOUNT * Math.random();
                        bank.transfer(fromAccount, toAccount, amount);
                        Thread.sleep((int) Math.random());
                    }
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            };
            Thread t = new Thread(r);
            t.start();
        }

    }
}

// åˆ›å»ºä¸€ä¸ªåŒæ­¥é“¶è¡Œç±»
class SynchBank {
    private final double[] accounts;
    // åˆ›å»ºé‡å…¥é”å¯¹è±¡
    /**
     * ReentrantLockï¼šé‡å…¥é”ï¼Œçº¿ç¨‹å¯ä»¥é‡å¤è·å¾—å·²æ‹¥æœ‰çš„é”
     * é”æœ‰ä¸€ä¸ªæŒæœ‰è®¡æ•°ï¼Œæ¥è·Ÿè¸ªå¯¹lockæ–¹æ³•çš„åµŒå¥—è°ƒç”¨ï¼Œçº¿ç¨‹æ¯æ¬¡è°ƒç”¨lockåï¼Œéƒ½è¦è°ƒç”¨unlockæ¥é‡Šæ”¾é”ã€‚
     */
    private ReentrantLock lock = new ReentrantLock();

    public SynchBank(int n, double initialBalance) {
        this.accounts = new double[n];
        Arrays.fill(accounts, initialBalance);
    }

    public void transfer(int from, int to, double amount) {
        try {
            // è·å¾—é”å¯¹è±¡
            this.lock.lock();
            if (accounts[from] < amount)
                return;
            System.out.print(Thread.currentThread());
            accounts[from] -= amount;
            accounts[to] += amount;
            System.out.printf(" %10.2f from %d to %d Total Balance: %10.2f%n", amount, from, to, getToatlBalance());
        } finally {
            // é‡Šæ”¾é”å¯¹è±¡
            this.lock.unlock();
        }
    }

    public double getToatlBalance() {
        try {
            this.lock.lock();
            double sum = 0;
            for (double a : accounts)
                sum += a;
            return sum;
        } finally {
            this.lock.unlock();
        }
    }

    public int size() {
        return this.accounts.length;
    }

}
```

#### æ¡ä»¶å¯¹è±¡

æœ‰äº›çº¿ç¨‹å¯èƒ½åªæœ‰åœ¨æ»¡è¶³æŸäº›æ¡ä»¶æ—¶æ‰ä¼šè¿è¡Œï¼Œå¦åˆ™å°†è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³è¯¥æ¡ä»¶ï¼ˆæ¯”å¦‚Bankç±»åœ¨è½¬è´¦æ—¶ï¼Œåªæœ‰åœ¨ä½™é¢å¤§äºç­‰äºè½¬è´¦é¢åº¦æ—¶æ‰èƒ½è¿›è¡Œè½¬è´¦ï¼‰ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¡ä»¶å¯¹è±¡æ¥å®ç°è¿™æ ·çš„åŠŸèƒ½ã€‚ä¸€ä¸ªé”å¯¹è±¡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ä»¶å¯¹è±¡ï¼Œé€šè¿‡awaitæ–¹æ³•å¯ä»¥æ—¶çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé€šè¿‡signalAllå¯ä»¥æ¿€æ´»å…¶ä»–å› ä¸ºè¯¥æ¡ä»¶å¯¹è±¡è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚

```java
import java.util.Arrays;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;

public class demo {
    public static final int NACCOUNTS = 100;
    public static final double INITIAL_BALANCE = 1000;
    public static final double MAX_AMOUNT = 1000;

    public static void main(String[] args) {
        ConditionBank bank = new ConditionBank(NACCOUNTS, INITIAL_BALANCE);
        for (int i = 0; i < NACCOUNTS; i++) {
            int fromAccount = i;
            Runnable r = () -> {
                try {
                    while (true) {
                        int toAccount = (int) (bank.size() * Math.random());
                        double amount = MAX_AMOUNT * Math.random();
                        bank.transfer(fromAccount, toAccount, amount);
                        Thread.sleep((int) Math.random());
                    }
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            };
            Thread t = new Thread(r);
            t.start();
        }

    }
}

//åˆ›å»ºä¸€ä¸ªæ¡ä»¶é“¶è¡Œç±»ï¼Œå½“å‡ºå¸è´¦æˆ·çš„ä½™é¢ä¸è¶³æ—¶ï¼Œå°†è¿›è¡Œç­‰å¾…ã€‚
class ConditionBank{
    private double[] accounts;
    //åˆ›å»ºä¸€ä¸ªé‡å…¥é”å¯¹è±¡
    private ReentrantLock lock = new ReentrantLock();
    //é€šè¿‡é‡å…¥é”åˆ›å»ºä¸€ä¸ªæ¡ä»¶
    private Condition sufficientFunds = lock.newCondition();

    public ConditionBank(int n, double amount) {
        this.accounts = new double[n];
        Arrays.fill(accounts, amount);
    }

    public void transfer(int from, int to, double amount) {
        try {
            lock.lock();
            /**
             * å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨awaitæ–¹æ³•ï¼Œçº¿ç¨‹å°†é‡Šæ”¾é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€
             * å½“æœ‰å…¶ä»–çº¿ç¨‹å®Œæˆè½¬è´¦æ“ä½œæ—¶ï¼Œå°†é€šè¿‡signalAllæ–¹æ³•å”¤é†’æ‰€æœ‰é€šè¿‡è¯¥æ¡ä»¶è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹
             * çº¿ç¨‹å”¤é†’åï¼Œå°†ä»ç­‰å¾…çŠ¶æ€è½¬æ¢ä¸ºå¯ä»¥è¿è¡ŒçŠ¶æ€ï¼Œå½“å¹¶ä¸ä¸€å®šé©¬ä¸Šè¿è¡Œï¼Œéœ€è¦çº¿ç¨‹è°ƒåº¦å™¨åˆ†é…è¿è¡Œæ—¶é—´
             * å½“çº¿ç¨‹å†æ¬¡è¿è¡Œæ—¶ï¼Œçº¿ç¨‹å°†å†æ¬¡è·å¾—é”ï¼Œå¹¶ä»è°ƒç”¨awaitæ–¹æ³•çš„åœ°æ–¹ç»§ç»­è¿è¡Œ
             */
            while (accounts[from] < amount)
                sufficientFunds.await();
            System.out.print(Thread.currentThread());
            accounts[from] -= amount;
            accounts[to] += amount;
            System.out.printf(" %10.2f from %d to %d Total Balance: %10.2f%n", amount, from, to, getToatlBalance());
            //é€šè¿‡signalAllæ–¹æ³•å”¤é†’å…¶ä»–å› ä¸ºè¯¥æ¡ä»¶è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹
            sufficientFunds.signalAll();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }

    public double getToatlBalance() {
        double sum = 0;
        for (double a : accounts)
            sum += a;
        return sum;
    }

    public int size() {
        return this.accounts.length;
    }

}
```

#### synchronized

Synchronizedå…³é”®å­—å¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸äº†è§£é”çš„å…·ä½“ç»†èŠ‚çš„æƒ…å†µä¸‹æ›´åŠ æ–¹ä¾¿çš„ä¿è¯ä¸´ç•ŒåŒºçš„æ•°æ®å®‰å…¨ã€‚åœ¨Javaä¸­ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªé”ï¼Œå¹¶ä¸”æœ‰`ä¸€ä¸ª`æ¡ä»¶å¯¹è±¡ï¼Œsynchronizedæ–¹æ³•ä½¿ç”¨å¯¹è±¡å†…éƒ¨çš„é”æ¥ä¿è¯ä¸´ç•ŒåŒºä»£ç å—çš„æ•°æ®å®‰å…¨ã€‚ä½¿ç”¨Objectçš„waitæ–¹æ³•ä½¿çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œä½¿ç”¨notifyæˆ–notifyAllæ–¹æ³•æ¿€æ´»è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚ä¸åŒsynchronizedä»£ç å—ä½¿ç”¨çš„ä¸åŒé”å¦‚ä¸‹ï¼š

| synchronizedä¿®é¥°çš„ä½ç½® |    ä½¿ç”¨çš„é”å¯¹è±¡   |
| :---------------: | :---------: |
|        ä»£ç å—        |   æ‰‹åŠ¨æä¾›é”å®šå¯¹è±¡  |
|        ä¸€èˆ¬æ–¹æ³•       |  æ–¹æ³•çš„å¯¹åº”çš„ç±»å¯¹è±¡  |
|        é™æ€æ–¹æ³•       | ç±»å¯¹åº”çš„classå¯¹è±¡ |

#### å®¢æˆ·ç«¯é”å®š

æœ‰æ—¶ï¼Œç¨‹åºå‘˜ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡é”æ¥å®ç°é¢å¤–çš„åŸå­æ“ä½œï¼Œè¿™ç§åšæ³•ç§°ä¸º_å®¢æˆ·ç«¯é”å®š_ï¼Œå®¢æˆ·ç«¯é”å®šæ˜¯éå¸¸è„†å¼±çš„ï¼Œé€šå¸¸ä¸å»ºè®®ä½¿ç”¨ã€‚é€šè¿‡ä»¥ä¸‹ä»£ç ä½ å°±ä¼šå‘ç°é—®é¢˜ï¼Œ`é”å®šä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸æ˜¯å…¶ä»–çº¿ç¨‹ä¸èƒ½è®¿é—®å¯¹è±¡ï¼Œè€Œæ˜¯ä¸èƒ½å†è·å¾—é”ï¼Œé‚£äº›ä¸ç”¨è·å¾—é”å°±ç›´æ¥å¯¹å¯¹è±¡è¿›è¡Œæ“ä½œçš„æ–¹æ³•ä»ç„¶ä¼šç ´åæ•°æ®`ï¼Œæ‰€ä»¥è¯´ï¼Œå®¢æˆ·ç«¯é”å®šæ˜¯ä¸å®‰å…¨ï¼Œå› ä¸ºä½ ä¸èƒ½ç¡®ä¿è¯¥å¯¹è±¡æ˜¯å¦æ‰€æœ‰æ›´æ”¹å™¨æ–¹æ³•éƒ½æ˜¯åŒæ­¥çš„ï¼Œæˆ–è€…æ‰€æœ‰å¯¹è¯¥å¯¹è±¡è¿›è¡Œæ›´æ”¹çš„æ–¹æ³•ä½¿ç”¨åŒä¸€ä¸ªé”å¯¹è±¡ã€‚

```java
public class TestClientsideLocking {
    public static void main(String[] args) {
        User user = new User("zhanghao");
        Runnable synch = () -> {
            while (true)
                user.setNamebySynch("synch");
        };
        Runnable unSynch = () -> {
            while (true) {
                try {
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                user.setName("unSynch");
            }
        };
        new Thread(synch).start();
        new Thread(unSynch).start();
    }
}

class User {
    private String name;

    public synchronized void setNamebySynch(String name) {
        System.out.println("é”å®š...");
        try {
            Thread.sleep(10000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        this.name = name;
        System.out.println("è§£é™¤...");
    }

    public void setName(String name) {
        this.name = name;
        System.out.println("setName successful...");
    }

    public User(String name) {
        this.name = name;
    }
}
```

#### ç›‘è§†å™¨

ç›‘è§†å™¨å…·æœ‰ä¸€ä¸‹ç‰¹å¾ï¼š

* ç›‘è§†å™¨åªåŒ…å«ç§æœ‰å­—æ®µ
* ç›‘è§†å™¨ç±»çš„æ¯ä¸€ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªç›¸å…³è”çš„é”
* æ‰€æœ‰æ–¹æ³•ç”±è¿™ä¸ªé”é”å®š
* é”å¯ä»¥æœ‰ä»»æ„å¤šä¸ªæ¡ä»¶

Javaè®¾è®¡è€…ä»¥ä¸å¤ªä¸¥æ ¼çš„æ–¹æ³•é‡‡ç”¨äº†ç›‘è§†å™¨çš„æ¦‚å¿µï¼ŒJavaä¸­æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨é”å’Œä¸€ä¸ªå†…éƒ¨æ¡ä»¶ã€‚å¦‚æœä½¿ç”¨synchronizedï¼Œé‚£ä¹ˆï¼Œä»–è¡¨ç°çš„å°±åƒæ˜¯ä¸€ä¸ªè§è¯†å™¨æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡wait/notify/notifyAllæ–¹æ³•æ¥è®¿é—®æ¡ä»¶å˜é‡ã€‚Javaå¯¹è±¡åœ¨ä»¥ä¸‹3ä¸ªé‡è¦æ–¹é¢ä¸åŒäºç›‘è§†å™¨ï¼Œè¿™å‰Šå¼±äº†çº¿ç¨‹çš„å®‰å…¨æ€§ï¼š

* å­—æ®µä¸è¦æ±‚æ˜¯private
* æ–¹æ³•ä¸è¦æ±‚æ˜¯synchronized
* å†…éƒ¨é”å®šå¯¹å®¢æˆ·æ˜¯å¯ç”¨çš„

#### æ­»é”

æœ‰å¯èƒ½æ‰€æœ‰çš„çº¿éƒ½å› ä¸ºæŸäº›åŸå› è¢«é˜»å¡ï¼Œè¿™æ ·çš„çŠ¶æ€è¢«ç§°ä¹‹ä¸º_æ­»é”_ã€‚é€ æˆæ­»é”çš„åŸå› å¾ˆå¤šï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­è¦é¿å…æ­»é”ã€‚

#### çº¿ç¨‹å±€éƒ¨å˜é‡

å¯¹äºæœ‰äº›å·¥å…·ç±»ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åˆ›å»ºå¯¹å¤šä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡å°±å¯ä»¥åå¤ä½¿ç”¨ï¼Œæ¯”å¦‚Randomã€SimpleDateFormatç­‰ï¼Œä½†æ˜¯è¿™äº›ç±»å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼Œå¾ˆå¯èƒ½å‡ºç°é—®é¢˜ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡ThreadLoaclç±»æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```java
import java.text.SimpleDateFormat;

public class TestThreadLocal {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œä»–æ˜¯ä¸€ä¸ªæ³›å‹å¯¹è±¡
        ThreadLocal<SimpleDateFormat> sdf = ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
        int i = 1000;
        Runnable date = () -> {
            int j = 100;
            while (j-- > 0)
                //å½“ä¸€ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡è°ƒç”¨getæ–¹æ³•æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡å¹¶è¿”å›ï¼Œä»¥åå†æ¬¡è°ƒç”¨åˆ™ä¸ä¼šåˆ›å»ºæ–°çš„å¯¹è±¡
                System.out.println(sdf.get().format(System.currentTimeMillis()));
        };
        while (i-- > 0) {
            new Thread(date).start();
        }
    }
}
```

#### çº¿ç¨‹å®‰å…¨çš„é›†åˆ

çº¿ç¨‹å®‰å…¨çš„é›†åˆä¸»è¦æ˜¯`java.util.concurrent`åŒ…ä¸‹çš„é›†åˆç±»ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ­¥åŒ…è£…å™¨è¿›è¡ŒåŒ…è£…ï¼Œä½¿éçº¿ç¨‹å®‰å…¨çš„é›†åˆå˜æˆçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œä½†æ˜¯åº”è¯¥ä¿è¯æ²¡æœ‰ä»»ä½•æ–¹æ³•å¯ä»¥é€šè¿‡åŸå§‹çš„éåŒä¸æ–¹æ³•è®¿é—®æ•°æ®ç»“æ„ã€‚

## äºŒã€ä»»åŠ¡å’Œçº¿ç¨‹æ± 

### 2.1 Callableä¸Future

Runnableæ–¹æ³•å¯ä»¥ç®€å•çš„å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯Runnableæ¥å£çš„runæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿä¸èƒ½æŠ›å‡ºä»»ä½•çš„å¼‚å¸¸ï¼Œä½†æ˜¯Callableæ–¹æ³•å³èƒ½æœ‰æ–¹æ³•çš„è¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºå¼‚å¸¸ã€‚Callableæ–¹æ³•å¯ä»¥ç”¨æ¥è¿›è¡Œå¼‚æ­¥è®¡ç®—ã€‚

Futureç”¨æ¥ä¿å­˜å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚Futureæ¥å£æœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š

* V get() å¦‚æœè®¡ç®—æ²¡æœ‰å®Œæˆï¼Œè¯¥æ–¹æ³•å°†ä¼šé˜»å¡ï¼Œç›´åˆ°è®¡ç®—å®Œæˆï¼›å¦‚æœè®¡ç®—å·²ç»å®Œæˆï¼Œå°†ç«‹å³è¿”å›ç»“æœã€‚
* V get(long timout, TimeUnit unit) å¦‚æœè®¡ç®—æ²¡æœ‰å®Œæˆï¼Œè¯¥æ–¹æ³•ä¼šé˜»å¡ï¼Œå¦‚æœåœ¨è¶…æ—¶ä¹‹å‰æ²¡æœ‰å®Œæˆï¼Œå°†æŠ›å‡ºTimoutExceptionå¼‚å¸¸ï¼Œå¦‚æœè®¡ç®—è¢«å–æ¶ˆå°†æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚
* void cancel(boolean mayInterrupt)
* boolean isCancel()
* boolean isDone()

FutureTaskç±»å®ç°äº†Futureä¸Runnableæ¥å£ï¼Œå¹¶æ¥å—ä¸€Callableæ¥å£å¯¹è±¡ã€‚

```java
import java.util.concurrent.Callable;
import java.util.concurrent.FutureTask;

public class DemoFutureTask{
    public static void main(String[] args)throws Exception{
        Callable<String> task = new MyTask();
        var futerTask = new FutureTask<>(task);
        new Thread(futerTask).start();
        System.out.println(futerTask.get());
    }
}

class MyTask implements Callable<String>{
    public String call(){
        return "Hello Callable";
    }
}
```

### 2.2 æ‰§è¡Œå™¨

æ‰§è¡Œå™¨ç±»æœ‰è®¸å¤šå·¥å‚æ–¹æ³•ï¼Œç”¨æ¥æ„é€ çº¿ç¨‹æ± 

|                æ–¹æ³•                |                           æè¿°                           |
| :------------------------------: | :----------------------------------------------------: |
|        newCachedThreadPool       |                   å¿…è¦æ˜¯åˆ›å»ºæ–°çº¿ç¨‹ï¼Œç©ºé—²çº¿ç¨‹ä¼šä¿ç•™60ç§’                  |
|        newFixedThreadPool        |                  æ± ä¸­åŒ…å«å›ºå®šæ•°ç›®çš„çº¿ç¨‹ï¼›ç©ºæƒ³çº¿ç¨‹ä¼šä¸€ç›´ä¿ç•™                 |
|       new WorkStealingPool       | ä¸€ç§é€‚åˆfork-joinä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œå…¶ä¸­å¤æ‚çš„ä»»åŠ¡ä¼šåˆ†è§£ä¸ºæ›´åŠ ç®€å•çš„ä»»åŠ¡ï¼Œç©ºé—²çº¿ç¨‹ä¼šâ€œå¯†å–â€è¾ƒç®€å•çš„ä»»åŠ¡ |
|         newSingThreadPool        |                åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹â€œæ± â€ï¼Œä¼šé¡ºåºçš„æ‰§è¡Œæ‰€æäº¤çš„ä»»åŠ¡               |
|        newScheduThreadPool       |                      ç”¨äºè°ƒåº¦æ‰§è¡Œçš„å›ºå®šçº¿ç¨‹æ±                       |
| newSingleThreadScheduledExecutor |                      ç”¨äºè°ƒåº¦æ‰§è¡Œçš„å•çº¿ç¨‹â€œæ± â€                     |

```java
import java.util.concurrent.*;

public class TestExecutors {
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± 
        ExecutorService pool = Executors.newFixedThreadPool(10);
        //åˆ›å»ºä¸€ä¸ªæ•°ç»„ç”¨æ¥å­˜æ”¾Futureå¯¹è±¡
        Future[] fs = new Future[10];
        //å¾ªç¯åˆ›å»ºæ˜¯ä¸ªä»»åŠ¡ï¼Œå¹¶æäº¤ç»™çº¿ç¨‹æ± 
        for (int i = 0; i < 10; i++) {
            fs[i] = pool.submit(new Callable<String>() {
                public String call() {
                    return "Future: " + Thread.currentThread().getName();
                }
            });
        }
        //ä¼‘çœ 1S
        try {
            Thread.sleep(1000);
        } catch (Exception e) {
            e.printStackTrace();
        }
        System.out.println("Start get result...");
        //è·å–æ‰§è¡Œçš„ç»“æœ
        for (Future f : fs) {
            try{
                System.out.println(f.get());
            }catch(Exception e){
                e.printStackTrace();
            }
        }
        try {
            Thread.sleep(1000);
        } catch (Exception e) {
            e.printStackTrace();
        }
        //ç¨‹åºç»“æŸä¹‹å‰ï¼Œä¸€å®šè¦è°ƒç”¨shutdownæ–¹æ³•ï¼Œä¸ç„¶ä¸»çº¿ç¨‹æ°¸è¿œä¸ä¼šæ­»äº¡ï¼Œç¨‹åºä¸ä¼šç»“æŸ
        System.out.println("Start shutDown...");
        pool.shutdown();
    }
}
```

### 2.3 fork-joinæ¡†æ¶

ä¸€äº›åº”ç”¨å¯èƒ½å¯¹æ¯ä¸€ä¸ªå¤„ç†å™¨å†…æ ¸åˆ†åˆ«ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä»¥å®Œæˆå¯†é›†å‹è®¡ç®—ä»»åŠ¡ã€‚ä½ å¯ä»¥è§ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªä¸åŒçš„ä»»åŠ¡æ¥è°ƒç”¨æ›´å¤šçš„å¤„ç†å™¨å†…æ ¸ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«åœ°å®Œæˆä½ çš„å·¥ä½œã€‚jdk7å¼€å§‹æä¾›äº†fork-joinæ¡†æ¶ï¼Œç”¨æ¥æ”¯æŒè¿™ç§æƒ…å†µã€‚

ä¸‹è¾¹æ˜¯ä¸€ä¸ªå¤±è´¥çš„æ¡ˆä¾‹ï¼Œè™½ç„¶ä½¿ç”¨äº†fork-joinæ¡†æ¶ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æé«˜æ•ˆç‡ï¼Œè€Œæ˜¯é™ä½äº†æ•ˆç‡ï¼Œæˆ‘è®¤ä¸ºä¸»è¦æ˜¯ä¸€ä¸‹åŸå› é€ æˆçš„ï¼š

Fibonacciçš„æ¯ä¸ªå·¥ä½œéƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯æ•°é‡ååˆ†åºå¤§ï¼Œä»»åŠ¡æ•°é‡è¿œè¿œè¶…è¿‡å¤„ç†å™¨å†…æ ¸æ•°é‡ï¼Œå¤§é‡çš„æ—¶é—´éƒ½è¯è´¹åœ¨åˆ›å»ºå¯¹è±¡å’Œçº¿ç¨‹çš„è°ƒåº¦ä¸Šï¼Œæ‰€ä»¥æ•ˆç‡ååˆ†ä½ä¸‹ã€‚è¿™åªæ˜¯æˆ‘çš„ä¸ªäººè§è§£ï¼Œå¦‚æœç†è§£æœ‰è¯¯æ¬¢è¿æŒ‡æ•™ã€‚

```java
import java.util.concurrent.ForkJoinPool;
import java.util.concurrent.RecursiveTask;

public class TestForkJoin {
    public static Long fibonacci(int i) {
        if (i <= 2)
            return (long) 1;
        else
            return fibonacci(i - 1) + fibonacci(i - 2);
    }

    public static void main(String[] args) {
        Long begin = System.currentTimeMillis();
        //åˆ›å»ºè®¡ç®—ä»»åŠ¡çš„å¯¹è±¡
        Fibonacci fibonacci = new Fibonacci(45);
        //åˆ›å»ºä¸€ä¸ªForkJoinPoolçº¿ç¨‹æ± 
        ForkJoinPool pool = new ForkJoinPool();
        //é€šè¿‡çº¿ç¨‹æ± æ¥æ‰§è¡Œè®¡ç®—ä»»åŠ¡
        pool.invoke(fibonacci);
        //é€šè¿‡çº¿ä»»åŠ¡å¯¹è±¡è·å¾—è®¡ç®—ç»“æœã€‚
        long res = fibonacci.join();
        // long res = fibonacci(45);
        Long end = System.currentTimeMillis();
        System.out.println(res + " -> " + (end - begin));
    }
}

//åˆ›å»ºæ–æ³¢é‚£å¥‘ç±»ï¼Œç»§æ‰¿RecursTask<T>ï¼Œæ¥å®ç°fork-jionæ¡†æ¶
class Fibonacci extends RecursiveTask<Long> {

    private int number;

    public Fibonacci(int a) {
        this.number = a;
    }

    @Override   //ç”¨æ¥è‡ªè¡Œçš„å…·ä½“æ–¹æ³•ï¼Œæ¥è‡ªäºçˆ¶ç±»
    protected Long compute() {
        if (this.number == 1 || this.number == 2) {
            return (long) 1;
        } else {
            //åˆ›å»ºä¸¤ä¸ªå­ä»»åŠ¡å¯¹è±¡
            Fibonacci first = new Fibonacci(this.number - 1);
            Fibonacci second = new Fibonacci(this.number - 2);
            //æ‰§è¡Œä¸¤ä¸ªå­ä»»åŠ¡å¯¹è±¡
            invokeAll(first, second);
            //è¿”å›ä¼šä¸¤ä¸ªç»“æœçš„å’Œï¼Œå¦‚æœè¿‡è®¡ç®—æ²¡æœ‰å®Œæˆï¼Œé‚£ä¹ˆjoinæ–¹æ³•å°†ä¼šé˜»å¡ã€‚
            return first.join() + second.join();
        }
    }

}
```

### 2.4 å¼‚æ­¥è®¡ç®—

Futureçš„getæ–¹æ³•å¯èƒ½å¹¶ä¸å®Œç¾ï¼Œå› ä¸ºä½ ä¸çŸ¥é“éœ€è¦åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨getæ–¹æ³•æ¥è·å–è®¡ç®—çš„ç»“æœï¼Œå¦‚æœè®¡ç®—è¿˜æ²¡æœ‰å®Œæˆï¼Œä½ å°†ä¸€ç›´é˜»å¡ä¸‹å»ï¼Œæœ‰æ—¶å€™ä½ æ›´å¸Œæœ›å½“è®¡ç®—ç»“æŸåè‡ªåŠ¨çš„æ¥æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œæˆ–è®¸æ˜¯ä¿å­˜ä½ çš„ç»“æœï¼Œæˆ–è®¸æ˜¯è¿›è¡Œä¸‹ä¸€æ­¥è®¡ç®—ï¼Œæˆ–è€…ä»€ä¹ˆå…¶ä»–çš„ã€‚CompletableFutureç±»æä¾›äº†è¿™ä¸ªèƒ½åŠ›ï¼Œä½ å¯æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°æ¥è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚ä½ å¯ä»¥é€šè¿‡then...æ–¹æ³•æ¥è®¾ç½®æ¥ä¸‹æ¥çš„ä»»åŠ¡ï¼Œæˆ–è€…æ˜¯é€šè¿‡when...æ–¹æ³•æ¥è®¾ç½®æŸä¸€æ—¶åˆ»æ‰§è¡Œçš„ä»£ç ã€‚

```java
import java.util.concurrent.CompletableFuture;

public class TestCompletableFuture {
    public static void main(String[] args) {
        // é€šè¿‡é™æ€æ–¹æ³•supplyAsyncï¼Œåˆ›å»ºä¸€ä¸ªCompletableFutureï¼Œå¦‚æœä¸ç»™å®šexecutorï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼
        CompletableFuture<String> sayHello = CompletableFuture.supplyAsync(() -> {
            // æµ‹è¯•æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µ
            // int a = 1 / 0;
            return "Hello CompletableFuture";
        });
         // é€šè¿‡cancelæ–¹æ³•å¯ä»¥å–æ¶ˆä¸€ä¸ªä»»åŠ¡
         // sayHello.cancel(true);
         /**
          * ä¸ºCompletalbleFutureæä¾›ä¸€ä¸ªå›è°ƒï¼Œå‚æ•°æ˜¯ä¸€ä¸ªCustomer<T>æ¥å£
          * å½“è®¡ç®—å®Œæˆæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨thenAcceptæ–¹æ³•ï¼Œå‚æ•°ä¸ºè®¡ç®—çš„ç»“æœ
          */ 
        sayHello.thenAccept(s -> System.out.println(s));
        /**
         * CompletableFutureå®Œæˆçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š1ã€å¾—åˆ°ä¸€ä¸ªç»“æœï¼›2ã€æœ‰çš„ä¸€ä¸ªæœªæ•è·çš„å¼‚å¸¸ã€‚
         * é€šè¿‡whenCompletableæ–¹æ³•å°†ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¼‚å¸¸ç»“æœï¼Œä¸€ä¸ªæ˜¯ç»“æœ
         * å¦‚æœä»»åŠ¡è¢«å–æ¶ˆæˆ–å‘ç”Ÿæœªæ•è·çš„å¼‚å¸¸ï¼Œå°†è¿”å›ä¸ªå¼‚å¸¸å¯¹è±¡ï¼Œç»“æœå¯¹è±¡ä¸ºnullï¼›å¦‚æœæ­£å¸¸è®¡ç®—å®Œï¼Œå°†è¿”å›ä¸€ä¸ªç»“æœå¯¹è±¡ï¼Œå¼‚å¸¸å¯¹è±¡ä¸ºnull
         */
        sayHello.whenComplete((s, t) -> {
            System.out.println("T -> " + t);
            System.out.println("S -> " + s);
        });
        // ä¸»çº¿ç¨‹ä¸€å®šè¦ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œä½¿è®¡ç®—ä»»åŠ¡å®Œæˆï¼Œä¸ç„¶ï¼Œä¸»çº¿ç¨‹æ­»äº¡ï¼Œè™šæ‹Ÿæœºé€€å‡º
        try {
            Thread.sleep(2000);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## ä¸‰ã€è¿›ç¨‹

æˆ‘è§‰å¾—è¿™å¹¶ä¸æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥åªæ˜¯ä¸¾äº†ä¸€ä¸ªä¾‹å­

### 3.1åˆ›å»ºä¸€ä¸ªè¿›ç¨‹

```java
import java.util.Scanner;

public class TestProcessBuilder {
    public static void main(String[] args) throws Exception{
        // é€šè¿‡ProcessBuilderæ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åè°ƒç”¨startæ–¹æ³•æ¥å¯åŠ¨å¹¶è·å¾—è¿›ç¨‹å¯¹è±¡
        Process p = new ProcessBuilder("pwd").start();
        // è·å¾—è¿›ç¨‹çš„æ‰§è¡Œç»“æœæµ
        Scanner sc = new Scanner(p.getInputStream());
        // è·å¾—æ‰§è¡Œç»“æœ
        while(sc.hasNextLine()){
            System.out.println(sc.nextLine());
        }
    }
}
```

## å››ã€ç»“å°¾

æ²¡æœ‰å†™è¿‡å¾ˆå¤šåšå®¢ï¼Œæ‰€ä»¥å†™çš„å¯èƒ½æœ‰äº›ç²—ç•¥ï¼Œè¯·è§è°…ï¼›ä¸€äº›ç±»åªæ˜¯æ¼”ç¤ºæœ€ç®€å•çš„åŠŸèƒ½ï¼Œæ›´å¤šçš„åŠŸèƒ½è¯·å‚è€ƒAPIæ–‡æ¡£ã€‚

\*\*ä»£ç å¹¶ä¸æ˜¯çœ‹æ‡‚çš„ï¼Œä¹Ÿä¸æ˜¯æƒ³é€šçš„ï¼Œè€Œæ˜¯æ•²æ˜ç™½çš„ã€‚\*\*å†…æœ‰ä»£ç æ˜¯æ•²ä¸€éè¿˜ä¸æ‡‚å¾—ï¼Œå¦‚æœæœ‰è¯·å†æ•²ä¸€éã€‚

æˆ‘è§‰å¾—ç¼–å†™çº¿ç¨‹ä»£ç å°±åƒæ˜¯æ¥ç®¡ç†å¤šä¸ªäººæ¥æ‰§è¡Œä»»åŠ¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æƒ³æ˜¯ä¸€ä¸ªäººï¼Œä½ éœ€è¦é€šè¿‡ä½ çš„åè°ƒæ¥ä½¿ä»–ä»¬åˆ†å·¥åˆä½œï¼Œæ—¢è¦ä¿è¯ä»–ä»¬çš„å·¥ä½œæ•ˆç‡ï¼Œåˆè¦ä¿è¯ä»–ä»¬äº’ç›¸ä¸ä¼šå‘ç”ŸçŸ›ç›¾ã€‚è¿™æ˜¯ä¸€é¡¹å¾ˆå¤æ‚çš„å·¥ä½œã€‚
